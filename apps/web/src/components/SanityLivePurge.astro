---
// Purge-only SanityLive â€” no navigation, just cache busting
// Used in the CMS layout so editors with Studio open keep the cache fresh
---

<sanity-live-purge></sanity-live-purge>

<script>
import type { LiveEvent } from '@sanity/client';
import { liveSanityClient } from '@/sanity';

class SanityLivePurge extends HTMLElement {
  private subscription: { unsubscribe: () => void } | null = null;

  connectedCallback() {
    this.subscribe();
  }

  disconnectedCallback() {
    this.subscription?.unsubscribe();
    this.subscription = null;
  }

  private subscribe() {
    this.subscription?.unsubscribe();

    this.subscription = liveSanityClient.live.events().subscribe({
      next: (event: LiveEvent) => {
        if (event.type === 'message' && event.tags?.length) {
          fetch('/api/revalidate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tags: event.tags }),
          }).catch((err: Error) => console.debug('[SanityLivePurge] purge failed:', err.message));
        }
      },
      error: (err: Error) => console.debug('[SanityLivePurge] subscription error:', err.message),
    });
  }
}

customElements.define('sanity-live-purge', SanityLivePurge);
</script>
