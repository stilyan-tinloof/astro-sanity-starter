---
import { sanityFetch } from '@/lib/sanityFetch';
import { PAGE_QUERY } from '@/sanity/queries';
import type { PAGE_QUERY_RESULT } from '../../sanity.types';
import Layout from '../layouts/layout.astro';
import PageContent from '../components/PageContent.astro';
import { CDN_MAX_AGE, BROWSER_MAX_AGE } from '@/lib/cache';

const { slug } = Astro.params;

const { data, syncTags } = await sanityFetch<PAGE_QUERY_RESULT>({
  query: PAGE_QUERY,
  params: { slug },
  cookies: Astro.cookies,
});

if (!data?.page) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

// Set cache headers
Astro.response.headers.set('Cache-Control', `public, max-age=${BROWSER_MAX_AGE}, s-maxage=${CDN_MAX_AGE}`);
if (syncTags.length > 0) {
  Astro.response.headers.set('Cache-Tag', syncTags.join(','));
}
---

<Layout
  title={data.page?.title || 'Page'}
  headerData={data.header}
  footerData={data.footer}
  syncTags={syncTags}
>
  <PageContent title={data.page?.title} content={data.page?.content} />
</Layout>
